<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>E-commerce - Enhanced</title>
<link rel='stylesheet' href='../shared/styles.css'>
<style>
.ecom-container { max-width: 1200px; margin: 0 auto; }
.filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.filters input, .filters select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
.filters input[type="search"] { flex: 1; min-width: 200px; }
.product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
.product-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; transition: transform 0.2s, box-shadow 0.2s; }
.product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.product-img { width: 100%; height: 180px; background: #f5f5f5; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; font-size: 48px; }
.product-name { font-weight: bold; margin-bottom: 5px; }
.product-category { font-size: 12px; color: #666; margin-bottom: 5px; }
.product-price { font-size: 18px; color: #2196F3; font-weight: bold; margin: 10px 0; }
.product-rating { color: #FFA500; margin-bottom: 10px; }
.product-actions { display: flex; gap: 10px; margin-top: 10px; }
.product-actions button { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.btn-add-cart { background: #4CAF50; color: white; }
.btn-add-cart:hover { background: #45a049; }
.btn-wishlist { background: #f44336; color: white; }
.btn-wishlist:hover { background: #da190b; }
.btn-wishlist.active { background: #c62828; }
.cart-sidebar { position: fixed; right: -400px; top: 0; width: 400px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s; z-index: 1000; overflow-y: auto; }
.cart-sidebar.open { right: 0; }
.cart-header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
.cart-items { padding: 20px; }
.cart-item { display: flex; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
.cart-item-img { width: 80px; height: 80px; background: #f5f5f5; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 32px; }
.cart-item-details { flex: 1; }
.cart-item-name { font-weight: bold; margin-bottom: 5px; }
.cart-item-price { color: #2196F3; margin-bottom: 10px; }
.cart-item-qty { display: flex; align-items: center; gap: 10px; }
.cart-item-qty button { padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
.cart-item-qty input { width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 5px; }
.cart-footer { padding: 20px; border-top: 2px solid #ddd; position: sticky; bottom: 0; background: white; }
.cart-total { font-size: 20px; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; }
.cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
.cart-overlay.open { display: block; }
.badge { background: #f44336; color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; position: absolute; top: -8px; right: -8px; }
.wishlist-badge { background: #f44336; }
.out-of-stock { opacity: 0.6; }
.out-of-stock .btn-add-cart { background: #999; cursor: not-allowed; }
.discount-badge { background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; margin-left: 10px; }
.original-price { text-decoration: line-through; color: #999; font-size: 14px; margin-right: 10px; }
</style>
</head>
<body>
<a href='../index.html' class='small btn'>Back</a>

<div class='ecom-container'>
<section class='card'>
<h2>E-commerce Store - Enhanced</h2>

<!-- Filters & Search -->
<div class='filters'>
<input type='search' id='search' placeholder='Search products...' data-testid='product-search'>
<select id='category-filter' data-testid='category-filter'>
<option value=''>All Categories</option>
<option value='Electronics'>Electronics</option>
<option value='Clothing'>Clothing</option>
<option value='Home'>Home & Kitchen</option>
<option value='Books'>Books</option>
<option value='Sports'>Sports</option>
</select>
<select id='sort' data-testid='sort-products'>
<option value='name-asc'>Name (A-Z)</option>
<option value='name-desc'>Name (Z-A)</option>
<option value='price-asc'>Price (Low to High)</option>
<option value='price-desc'>Price (High to Low)</option>
<option value='rating-desc'>Rating (High to Low)</option>
</select>
<button class='btn' id='toggle-cart' style='position: relative;' data-testid='cart-button'>
üõí Cart <span id='cart-count' class='badge'>0</span>
</button>
<button class='btn' id='toggle-wishlist' style='position: relative;' data-testid='wishlist-button'>
‚ù§Ô∏è Wishlist <span id='wishlist-count' class='badge wishlist-badge'>0</span>
</button>
</div>

<!-- Product Grid -->
<div id='products' class='product-grid' data-testid='product-grid'></div>
</section>
</div>

<!-- Cart Sidebar -->
<div class='cart-overlay' id='cart-overlay'></div>
<div class='cart-sidebar' id='cart-sidebar'>
<div class='cart-header'>
<h3>Shopping Cart</h3>
<button class='btn' id='close-cart'>‚úï</button>
</div>
<div class='cart-items' id='cart-items'></div>
<div class='cart-footer'>
<div class='cart-total'>
<span>Total:</span>
<span id='cart-total' data-testid='cart-total'>‚Çπ0</span>
</div>
<button class='btn' id='checkout' style='width: 100%; background: #4CAF50; color: white; padding: 12px;' data-testid='checkout-button'>Proceed to Checkout</button>
<button class='btn' id='clear-cart' style='width: 100%; margin-top: 10px;' data-testid='clear-cart'>Clear Cart</button>
</div>
</div>

<script src='../shared/scripts.js'></script>
<script>
onReady(() => {
  const products = [
    {id: 1, name: 'Wireless Headphones', category: 'Electronics', price: 2999, originalPrice: 3999, rating: 4.5, stock: 15, img: 'üéß', discount: 25},
    {id: 2, name: 'Smart Watch', category: 'Electronics', price: 4999, originalPrice: 6999, rating: 4.2, stock: 8, img: '‚åö', discount: 29},
    {id: 3, name: 'Cotton T-Shirt', category: 'Clothing', price: 499, originalPrice: 799, rating: 4.0, stock: 50, img: 'üëï', discount: 38},
    {id: 4, name: 'Running Shoes', category: 'Sports', price: 1999, originalPrice: 2999, rating: 4.7, stock: 20, img: 'üëü', discount: 33},
    {id: 5, name: 'Coffee Maker', category: 'Home', price: 3499, originalPrice: 4999, rating: 4.3, stock: 12, img: '‚òï', discount: 30},
    {id: 6, name: 'Yoga Mat', category: 'Sports', price: 799, originalPrice: 1299, rating: 4.6, stock: 30, img: 'üßò', discount: 38},
    {id: 7, name: 'Bluetooth Speaker', category: 'Electronics', price: 1499, originalPrice: 2499, rating: 4.4, stock: 0, img: 'üîä', discount: 40},
    {id: 8, name: 'Cookbook', category: 'Books', price: 599, originalPrice: 899, rating: 4.8, stock: 25, img: 'üìö', discount: 33},
    {id: 9, name: 'Backpack', category: 'Clothing', price: 1299, originalPrice: 1999, rating: 4.1, stock: 18, img: 'üéí', discount: 35},
    {id: 10, name: 'Water Bottle', category: 'Sports', price: 399, originalPrice: 599, rating: 4.5, stock: 40, img: 'üíß', discount: 33},
    {id: 11, name: 'Desk Lamp', category: 'Home', price: 899, originalPrice: 1299, rating: 4.2, stock: 15, img: 'üí°', discount: 31},
    {id: 12, name: 'Notebook Set', category: 'Books', price: 299, originalPrice: 499, rating: 4.0, stock: 60, img: 'üìì', discount: 40}
  ];

  let cart = {};
  let wishlist = new Set();
  let filteredProducts = [...products];

  function renderProducts() {
    const container = el('products');
    container.innerHTML = '';
    
    filteredProducts.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card' + (p.stock === 0 ? ' out-of-stock' : '');
      card.setAttribute('data-testid', `product-${p.id}`);
      
      const stars = '‚≠ê'.repeat(Math.floor(p.rating)) + (p.rating % 1 >= 0.5 ? '¬Ω' : '');
      const stockText = p.stock === 0 ? '<span style="color: #f44336;">Out of Stock</span>' : `${p.stock} in stock`;
      
      card.innerHTML = `
        <div class='product-img'>${p.img}</div>
        <div class='product-category'>${p.category}</div>
        <div class='product-name' data-testid='product-name-${p.id}'>${p.name}</div>
        <div class='product-rating'>${stars} (${p.rating})</div>
        <div class='product-price'>
          <span class='original-price'>‚Çπ${p.originalPrice}</span>
          ‚Çπ${p.price}
          <span class='discount-badge'>${p.discount}% OFF</span>
        </div>
        <div class='small'>${stockText}</div>
        <div class='product-actions'>
          <button class='btn-add-cart' data-id='${p.id}' ${p.stock === 0 ? 'disabled' : ''} data-testid='add-to-cart-${p.id}'>
            ${p.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
          </button>
          <button class='btn-wishlist ${wishlist.has(p.id) ? 'active' : ''}' data-id='${p.id}' data-testid='wishlist-${p.id}'>
            ${wishlist.has(p.id) ? '‚ù§Ô∏è' : 'ü§ç'}
          </button>
        </div>
      `;
      container.appendChild(card);
    });

    // Add to cart listeners
    document.querySelectorAll('.btn-add-cart').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.id);
        const product = products.find(p => p.id === id);
        if (product.stock > 0) {
          cart[id] = (cart[id] || 0) + 1;
          renderCart();
          updateCartCount();
        }
      });
    });

    // Wishlist listeners
    document.querySelectorAll('.btn-wishlist').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.id);
        if (wishlist.has(id)) {
          wishlist.delete(id);
          btn.classList.remove('active');
          btn.textContent = 'ü§ç';
        } else {
          wishlist.add(id);
          btn.classList.add('active');
          btn.textContent = '‚ù§Ô∏è';
        }
        updateWishlistCount();
      });
    });
  }

  function renderCart() {
    const container = el('cart-items');
    container.innerHTML = '';
    
    if (Object.keys(cart).length === 0) {
      container.innerHTML = '<p class="small" style="text-align: center; padding: 40px;">Your cart is empty</p>';
      el('cart-total').textContent = '‚Çπ0';
      return;
    }

    let total = 0;
    Object.keys(cart).forEach(id => {
      const product = products.find(p => p.id == id);
      const qty = cart[id];
      const subtotal = product.price * qty;
      total += subtotal;

      const item = document.createElement('div');
      item.className = 'cart-item';
      item.setAttribute('data-testid', `cart-item-${id}`);
      item.innerHTML = `
        <div class='cart-item-img'>${product.img}</div>
        <div class='cart-item-details'>
          <div class='cart-item-name'>${product.name}</div>
          <div class='cart-item-price'>‚Çπ${product.price} √ó ${qty} = ‚Çπ${subtotal}</div>
          <div class='cart-item-qty'>
            <button class='qty-minus' data-id='${id}' data-testid='qty-minus-${id}'>‚àí</button>
            <input type='number' value='${qty}' min='1' max='${product.stock}' data-id='${id}' data-testid='qty-input-${id}'>
            <button class='qty-plus' data-id='${id}' data-testid='qty-plus-${id}'>+</button>
            <button class='btn' style='margin-left: auto;' data-id='${id}' data-testid='remove-item-${id}'>Remove</button>
          </div>
        </div>
      `;
      container.appendChild(item);
    });

    el('cart-total').textContent = `‚Çπ${total}`;

    // Quantity controls
    document.querySelectorAll('.qty-minus').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        if (cart[id] > 1) {
          cart[id]--;
          renderCart();
          updateCartCount();
        }
      });
    });

    document.querySelectorAll('.qty-plus').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const product = products.find(p => p.id == id);
        if (cart[id] < product.stock) {
          cart[id]++;
          renderCart();
          updateCartCount();
        }
      });
    });

    document.querySelectorAll('.cart-item-qty input').forEach(input => {
      input.addEventListener('change', () => {
        const id = input.dataset.id;
        const product = products.find(p => p.id == id);
        let qty = parseInt(input.value);
        if (qty < 1) qty = 1;
        if (qty > product.stock) qty = product.stock;
        cart[id] = qty;
        renderCart();
        updateCartCount();
      });
    });

    document.querySelectorAll('.cart-item-qty .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        delete cart[btn.dataset.id];
        renderCart();
        updateCartCount();
      });
    });
  }

  function updateCartCount() {
    const count = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
    el('cart-count').textContent = count;
  }

  function updateWishlistCount() {
    el('wishlist-count').textContent = wishlist.size;
  }

  function filterAndSort() {
    const search = el('search').value.toLowerCase();
    const category = el('category-filter').value;
    const sort = el('sort').value;

    // Filter
    filteredProducts = products.filter(p => {
      const matchesSearch = p.name.toLowerCase().includes(search) || p.category.toLowerCase().includes(search);
      const matchesCategory = !category || p.category === category;
      return matchesSearch && matchesCategory;
    });

    // Sort
    filteredProducts.sort((a, b) => {
      switch(sort) {
        case 'name-asc': return a.name.localeCompare(b.name);
        case 'name-desc': return b.name.localeCompare(a.name);
        case 'price-asc': return a.price - b.price;
        case 'price-desc': return b.price - a.price;
        case 'rating-desc': return b.rating - a.rating;
        default: return 0;
      }
    });

    renderProducts();
  }

  // Event listeners
  el('search').addEventListener('input', filterAndSort);
  el('category-filter').addEventListener('change', filterAndSort);
  el('sort').addEventListener('change', filterAndSort);

  el('toggle-cart').addEventListener('click', () => {
    el('cart-sidebar').classList.add('open');
    el('cart-overlay').classList.add('open');
  });

  el('close-cart').addEventListener('click', () => {
    el('cart-sidebar').classList.remove('open');
    el('cart-overlay').classList.remove('open');
  });

  el('cart-overlay').addEventListener('click', () => {
    el('cart-sidebar').classList.remove('open');
    el('cart-overlay').classList.remove('open');
  });

  el('checkout').addEventListener('click', () => {
    if (Object.keys(cart).length === 0) {
      alert('Your cart is empty!');
      return;
    }
    const total = el('cart-total').textContent;
    alert(`Checkout successful! Total: ${total}\n\nThank you for your purchase!`);
    cart = {};
    renderCart();
    updateCartCount();
    el('cart-sidebar').classList.remove('open');
    el('cart-overlay').classList.remove('open');
  });

  el('clear-cart').addEventListener('click', () => {
    if (confirm('Are you sure you want to clear your cart?')) {
      cart = {};
      renderCart();
      updateCartCount();
    }
  });

  el('toggle-wishlist').addEventListener('click', () => {
    if (wishlist.size === 0) {
      alert('Your wishlist is empty!');
    } else {
      const items = Array.from(wishlist).map(id => {
        const p = products.find(x => x.id === id);
        return p.name;
      }).join('\n');
      alert(`Wishlist Items:\n\n${items}`);
    }
  });

  // Initial render
  renderProducts();
  renderCart();
});
</script>
</body>
</html>
